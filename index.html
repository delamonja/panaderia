<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pan Artesanal | De La Monja</title>

<style>
:root{
    --blue:#1F2A44;
    --gold:#C6A75E;
    --bg:#ECECEF;
}

body{
    margin:0;
    padding:40px 20px;
    font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
    background:var(--bg);
    color:var(--blue);
    max-width:900px;
    margin:auto;
}

h1,h2{text-align:center;}
.product{border-bottom:1px solid #ddd;padding:20px 0;}
button{padding:8px 14px;background:var(--blue);color:white;border:none;cursor:pointer;}
input,textarea{width:100%;padding:10px;margin-top:10px;border:1px solid #ddd;}
.section{margin-top:50px;}
.total{font-weight:bold;font-size:1.2rem;margin-top:10px;}
</style>
</head>
<body>

<img src="logo.png" style="display:block;margin:0 auto 30px;max-width:200px;">
<h1>Pan Artesanal</h1>

<div id="product-list"></div>

<div class="section">
<h2>Haz tu pedido</h2>
<input id="name" placeholder="Nombre">
<input id="phone" placeholder="TelÃ©fono">
<textarea id="notes" placeholder="Notas (opcional)"></textarea>
<div id="review"></div>
<div class="total" id="total"></div>
<button onclick="submitOrder()">Enviar Pedido por WhatsApp</button>
</div>

<div class="section">
<h2>Pedido Especial (Pre-Orden)</h2>
<input id="pre-name" placeholder="Nombre">
<input id="pre-phone" placeholder="TelÃ©fono">
<input id="pre-product" placeholder="Producto">
<input id="pre-qty" type="number" placeholder="Cantidad">
<input id="pre-date" type="date">
<textarea id="pre-notes" placeholder="Notas"></textarea>
<button onclick="submitPreOrder()">Enviar Pre-Orden</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, push, runTransaction }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
    apiKey:"AIzaSyCPZtmiXYBG33qOopqQTuK2yQjhPIs-nyU",
    authDomain:"delamonjapizza.firebaseapp.com",
    databaseURL:"https://delamonjapizza-default-rtdb.firebaseio.com",
    projectId:"delamonjapizza"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const PHONE_NUMBER="523411224987";

let products={},cart={};

onValue(ref(db,"bakeryStock"),snap=>{
    products=snap.val()||{};
    renderProducts();
});

function renderProducts(){
    const wrap=document.getElementById("product-list");
    wrap.innerHTML="";
    Object.entries(products).forEach(([id,item])=>{
        if(!item.active||item.inventory<=0) return;
        const qty=cart[id]||0;
        wrap.innerHTML+=`
            <div class="product">
                <strong>${item.tipo} â€” ${item.estilo||""}</strong><br>
                ${item.weight||""} | $${item.price}<br>
                Disponible: ${item.inventory}<br><br>
                <button onclick="add('${id}')">+</button>
                <button onclick="removeItem('${id}')">-</button>
                ${qty}
            </div>
        `;
    });
    updateReview();
}

window.add=id=>{
    const item=products[id];
    if(!cart[id]) cart[id]=0;
    if(cart[id]>=item.inventory) return;
    cart[id]++;
    updateReview();
};

window.removeItem=id=>{
    if(cart[id]) cart[id]--;
    updateReview();
};

function updateReview(){
    let total=0,html="";
    Object.entries(cart).forEach(([id,qty])=>{
        if(qty>0){
            const item=products[id];
            const subtotal=item.price*qty;
            total+=subtotal;
            html+=`${item.tipo} â€” ${item.estilo||""} x${qty} = $${subtotal}<br>`;
        }
    });
    document.getElementById("review").innerHTML=html;
    document.getElementById("total").innerText="Total: $"+total;
}

function getISOWeek(){
    const d=new Date();
    d.setHours(0,0,0,0);
    d.setDate(d.getDate()+4-(d.getDay()||7));
    const yearStart=new Date(d.getFullYear(),0,1);
    const week=Math.ceil((((d-yearStart)/86400000)+1)/7);
    return {year:d.getFullYear(),week};
}

async function generateOrderNumber(){
    const {year,week}=getISOWeek();
    const weekKey=`${year}-W${week}`;
    const refCounter=ref(db,"bakeryMeta/weeklyCounters/"+weekKey);
    const result=await runTransaction(refCounter,c=>(c||0)+1);
    const num=result.snapshot.val();
    return `${weekKey}-${String(num).padStart(3,"0")}`;
}

window.submitOrder=async()=>{
    const name=nameInput.value.trim();
    const phone=phoneInput.value.trim();
    if(!name||!phone) return;

    const orderNumber=await generateOrderNumber();
    let items=[],total=0;

    for(const [id,qty] of Object.entries(cart)){
        if(qty>0){
            const item=products[id];
            const subtotal=item.price*qty;
            total+=subtotal;

            items.push({
                id,
                tipo:item.tipo,
                estilo:item.estilo,
                weight:item.weight,
                price:item.price,
                quantity:qty,
                subtotal
            });

            await runTransaction(ref(db,"bakeryStock/"+id+"/inventory"),
                c=>Math.max(0,(c||0)-qty));
        }
    }

    if(items.length===0) return;

    push(ref(db,"bakeryOrders"),{
        orderNumber,
        type:"normal",
        name,phone,
        notes:notesInput.value.trim(),
        items,total,
        time:Date.now(),
        status:"pending"
    });

    let msg=`Pedido ${orderNumber}\n\nHola De La Monja ðŸ¥–\nSoy ${name}\nTel: ${phone}\n\n`;
    items.forEach(i=>{
        msg+=`â€¢ ${i.tipo} â€” ${i.estilo||""}\n`;
        msg+=`${i.weight||""}\n`;
        msg+=`$${i.price} x${i.quantity} = $${i.subtotal}\n\n`;
    });
    msg+=`TOTAL: $${total}\n`;

    window.open(`https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(msg)}`,"_blank");

    cart={};
    updateReview();
};

window.submitPreOrder=async()=>{
    const name=preName.value.trim();
    const phone=prePhone.value.trim();
    const product=preProduct.value.trim();
    const qty=parseInt(preQty.value);
    const date=preDate.value;
    const notes=preNotes.value.trim();

    if(!name||!phone||!product||!qty||!date) return;

    const orderNumber=await generateOrderNumber();

    push(ref(db,"bakeryOrders"),{
        orderNumber,
        type:"preorder",
        desiredDate:date,
        name,phone,notes,
        items:[{
            tipo:product,
            estilo:"Pre-Orden",
            weight:"",
            price:0,
            quantity:qty,
            subtotal:0
        }],
        total:0,
        time:Date.now(),
        status:"pending"
    });

    let msg=`Pedido ${orderNumber} (PRE-ORDEN)\n\nHola De La Monja ðŸ¥–\n`;
    msg+=`Soy ${name}\nTel: ${phone}\n\n`;
    msg+=`Producto: ${product}\nCantidad: ${qty}\nEntrega solicitada: ${date}\n`;
    if(notes) msg+=`Notas: ${notes}\n`;

    window.open(`https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(msg)}`,"_blank");
};

const nameInput=document.getElementById("name");
const phoneInput=document.getElementById("phone");
const notesInput=document.getElementById("notes");
const preName=document.getElementById("pre-name");
const prePhone=document.getElementById("pre-phone");
const preProduct=document.getElementById("pre-product");
const preQty=document.getElementById("pre-qty");
const preDate=document.getElementById("pre-date");
const preNotes=document.getElementById("pre-notes");
</script>

</body>
</html>
