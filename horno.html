<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horno | De La Monja</title>

<style>
:root{
    --blue:#1F2A44;
    --gold:#C6A75E;
    --bg:#ECECEF;
}

body{
    margin:0;
    padding:40px 20px;
    font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
    background:var(--bg);
    color:var(--blue);
    max-width:900px;
    margin:auto;
}

h1,h2{text-align:center;}

.section{margin-top:60px;}

input,button{
    width:100%;
    padding:10px;
    margin-top:10px;
    box-sizing:border-box;
    font-family:inherit;
}

button{
    background:var(--blue);
    color:white;
    border:none;
    cursor:pointer;
}

button.secondary{
    background:#eee;
    color:var(--blue);
}

.item{
    border-bottom:1px solid #ddd;
    padding:20px 0;
}

.row{
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:10px;
}

.small{
    width:auto;
    padding:6px 12px;
}

.total{
    font-weight:bold;
    margin-top:10px;
    font-size:1.1rem;
}
</style>
</head>
<body>

<img src="logo.png" style="display:block;margin:0 auto 30px;max-width:200px;">

<h1>Control de Horno</h1>

<div class="section">
<h2>Agregar Pan</h2>
<input id="tipo" placeholder="Tipo de pan">
<input id="estilo" placeholder="Estilo">
<input id="peso" placeholder="Peso / Tamaño (ej: 500g)">
<input id="precio" type="number" placeholder="Precio">
<input id="fecha" type="date">
<input id="inventario" type="number" placeholder="Inventario">
<button onclick="addProduct()">Agregar</button>
</div>

<div class="section">
<h2>Inventario</h2>
<div id="stock-list"></div>
</div>

<div class="section">
<h2>Pedidos</h2>
<div id="orders-list"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, runTransaction, get }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
    apiKey:"AIzaSyCPZtmiXYBG33qOopqQTuK2yQjhPIs-nyU",
    authDomain:"delamonjapizza.firebaseapp.com",
    databaseURL:"https://delamonjapizza-default-rtdb.firebaseio.com",
    projectId:"delamonjapizza"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ADD PRODUCT */

window.addProduct=()=>{
    const tipo=tipoInput.value.trim();
    const estilo=estiloInput.value.trim();
    const peso=pesoInput.value.trim();
    const precio=parseFloat(precioInput.value);
    const fecha=fechaInput.value;
    const inventario=parseInt(inventarioInput.value);

    if(!tipo||!precio||!inventario) return;

    push(ref(db,"bakeryStock"),{
        tipo,estilo,weight:peso,price:precio,
        bakeDate:fecha,inventory:inventario,active:true
    });

    document.querySelectorAll("input").forEach(i=>i.value="");
};

const tipoInput=document.getElementById("tipo");
const estiloInput=document.getElementById("estilo");
const pesoInput=document.getElementById("peso");
const precioInput=document.getElementById("precio");
const fechaInput=document.getElementById("fecha");
const inventarioInput=document.getElementById("inventario");

/* STOCK */

onValue(ref(db,"bakeryStock"),snap=>{
    const wrap=document.getElementById("stock-list");
    wrap.innerHTML="";
    if(!snap.val()) return;

    Object.entries(snap.val()).forEach(([id,item])=>{
        wrap.innerHTML+=`
            <div class="item">
                <strong>${item.tipo} — ${item.estilo||""}</strong><br>
                ${item.weight||""} | $${item.price}<br>
                Horneado: ${item.bakeDate||"-"}<br>
                Stock: ${item.inventory}
                <div class="row">
                    <button class="small" onclick="changeStock('${id}',1)">+</button>
                    <button class="small" onclick="changeStock('${id}',-1)">-</button>
                    <button class="small secondary" onclick="deleteProduct('${id}')">Eliminar</button>
                </div>
            </div>
        `;
    });
});

window.changeStock=(id,amount)=>{
    runTransaction(ref(db,"bakeryStock/"+id+"/inventory"),c=>{
        return Math.max(0,(c||0)+amount);
    });
};

window.deleteProduct=id=>{
    if(confirm("Eliminar producto?"))
        remove(ref(db,"bakeryStock/"+id));
};

/* ORDERS */

onValue(ref(db,"bakeryOrders"),snap=>{
    const wrap=document.getElementById("orders-list");
    wrap.innerHTML="";
    if(!snap.val()) return;

    Object.entries(snap.val())
    .sort((a,b)=>b[1].time-a[1].time)
    .forEach(([id,order])=>{
        let lines="";
        order.items.forEach(i=>{
            lines+=`
                ${i.tipo} — ${i.estilo||""}<br>
                ${i.weight||""}<br>
                $${i.price} x${i.quantity} = $${i.subtotal}<br><br>
            `;
        });

        wrap.innerHTML+=`
            <div class="item">
                <strong>
                Pedido ${order.orderNumber}
                ${order.type==="preorder"?" (PRE-ORDEN)":""}
                </strong><br>
                ${order.name}<br>
                Tel: ${order.phone}<br>
                ${order.type==="preorder"&&order.desiredDate?`Entrega solicitada: ${order.desiredDate}<br><br>`:"<br>"}
                ${lines}
                <div class="total">TOTAL: $${order.total}</div>
                ${order.notes?`<br>Notas: ${order.notes}`:""}
            </div>
        `;
    });
});
</script>
</body>
</html>
